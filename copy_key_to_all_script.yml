---
- name: Distribute SSH keys to Linux and Windows servers
  hosts: localhost
  connection: local
  vars:
    username: janina
    ssh_key_path: "/home/janina/.ssh/ansible.pub"

    linux_slaves:
      - 192.168.178.71
      - 192.168.178.72
    windows_slaves:
      - 192.168.178.74
      - 192.168.178.75
      - 192.168.178.79
      - 192.168.178.80
      - 192.168.178.81

  tasks:







    - name: Check file permissions
      stat:
        path: /home/janina/.ssh/ansible.pub
      register: file_info

    - debug:
        var: file_info


    - name: Get absolute path
      command: readlink -f /home/janina/.ssh/ansible.pub
      register: absolute_path

    - debug:
        var: absolute_path.stdout


    - name: Check SELinux context
      command: ls -Z /home/janina/.ssh/ansible.pub
      register: selinux_context

    - debug:
        var: selinux_context.stdout



    - name: Check current user
      command: whoami
      register: current_user

    - debug:
        var: current_user.stdout    



    - name: Read SSH key content
      set_fact:
        ssh_key_content: "{{ lookup('file', '/home/janina/.ssh/ansible.pub') }}"

    - debug:
        var: ssh_key_content    
        





    - name: Ensure SSH key file exists
      stat:
        path: "{{ ssh_key_path }}"
      register: ssh_key_file

    - name: Fail if SSH key file does not exist
      fail:
        msg: "SSH key file not found: {{ ssh_key_path }}"
      when: not ssh_key_file.stat.exists

    - name: Copy SSH key to Linux servers
      ansible.posix.authorized_key:
        user: "{{ username }}"
        state: present
        key: "{{ lookup('file', ssh_key_path) }}"
      loop: "{{ linux_slaves }}"
      delegate_to: "{{ item }}"

    - name: Add Linux servers to known_hosts
      known_hosts:
        name: "{{ item }}"
        state: present
      loop: "{{ linux_slaves }}"

    - name: Ensure .ssh directory exists on Windows servers
      win_file:
        path: "C:\\Users\\{{ username }}\\.ssh"
        state: directory
      loop: "{{ windows_slaves }}"
      delegate_to: "{{ item }}"

    - name: Copy SSH key to Windows servers
      win_copy:
        src: "{{ ssh_key_path }}"
        dest: "C:\\Users\\{{ username }}\\.ssh\\authorized_keys"
      loop: "{{ windows_slaves }}"
      delegate_to: "{{ item }}"

    - name: Add Windows servers to known_hosts
      known_hosts:
        name: "{{ item }}"
        state: present
      loop: "{{ windows_slaves }}"