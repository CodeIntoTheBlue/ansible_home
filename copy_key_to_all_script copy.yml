---
- name: Copy Ansible SSH-Key to Linux
  hosts: linux_slaves
  gather_facts: yes
  vars:
    ansible_ssh_key_path: /home/janina/.ssh/ansible.pub
  tasks:
    - name: Get home directory
      set_fact:
        user_home: "{{ ansible_env.HOME }}"

    - name: Debug home directory
      debug:
        var: user_home

    - name: Ensure .ssh directory exists
      file:
        path: "{{ user_home }}/.ssh"
        state: directory
        mode: '0700'

    - name: Debug directory creation
      debug:
        msg: "Directory ensured at {{ user_home }}/.ssh"

    - name: Copy SSH key to authorized_keys
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        key: "{{ lookup('file', ansible_ssh_key_path) }}"

    - name: Debug key file update
      debug:
        msg: "Authorized key file updated at {{ user_home }}/.ssh/authorized_keys"

    - name: Set correct permissions on authorized_keys
      file:
        path: "{{ user_home }}/.ssh/authorized_keys"
        mode: '0600'

    - name: Debug permissions set
      debug:
        msg: "Permissions set on {{ user_home }}/.ssh/authorized_keys"
















- name: Distribute SSH keys to Linux and Windows slaves
  hosts: localhost
  connection: local
  vars:
    username: janina
    ssh_key_path: "/home/janina/.ssh/ansible.pub"
    linux_slaves:
      - 192.168.178.71
      - 192.168.178.72
    windows_slaves:
      - 192.168.178.74
      - 192.168.178.75
      - 192.168.178.79
      - 192.168.178.80
      - 192.168.178.81

  tasks:
    - name: Read SSH key using sudo
      command: sudo -u janina cat {{ ssh_key_path }}
      register: ssh_key_content

    - name: Set SSH key fact
      set_fact:
        ssh_key: "{{ ssh_key_content.stdout }}"

    - name: Copy SSH key to Linux slaves
      authorized_key:
        user: "{{ username }}"
        state: present
        key: "{{ ssh_key }}"
      loop: "{{ linux_slaves }}"
      delegate_to: "{{ item }}"



    - name: Add Linux slaves to known_hosts
      known_hosts:
        name: "{{ item }}"
        state: present
      loop: "{{ linux_slaves }}"



# Windows

- name: Copy Ansible SSH-Key to windows
  hosts: windows_slaves
  gather_facts: no
  tasks:

    - name: Get USERPROFILE environment variable
      win_shell: echo $env:USERPROFILE
      register: userprofile_env

    - name: Debug userprofile_env
      debug:
        var: userprofile_env

    - name: Create a directory on Windows
      win_file:
        path: "{{ userprofile_env.stdout.strip() }}\\.ssh"
        state: directory

    - name: Debug directory creation
      debug:
        msg: "Directory created at {{ userprofile_env.stdout.strip() }}\\.ssh"

    - name: Create the authorized key file
      win_file:
        path: "{{ userprofile_env.stdout.strip() }}\\.ssh\\authorized_keys"
        state: touch

    - name: Debug key file creation
      debug:
        msg: "Authorized key file created at {{ userprofile_env.stdout.strip() }}\\.ssh\\authorized_keys"

    - name: Copy a file to Windows
      win_copy:
        src: home/janina/.ssh/ansible.pub
        dest: "{{ userprofile_env.stdout.strip() }}\\.ssh\\authorized_keys"

    - name: Debug file copy
      debug:
        msg: "File copied to {{ userprofile_env.stdout.strip() }}\\.ssh\\authorized_keys"






    - name: Add Windows slaves to known_hosts
      known_hosts:
        name: "{{ item }}"
        state: present
      loop: "{{ windows_slaves }}"